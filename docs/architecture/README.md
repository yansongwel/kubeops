# 架构文档

## 系统概述

KubeOps 是一个云原生、基于微服务架构的 Kubernetes 统一管理平台。系统架构遵循以下原则：

1. **微服务架构**：每个功能组件作为独立服务运行
2. **API 优先**：所有功能通过良好定义的 API 访问
3. **可插拔组件**：日志、监控、AI 提供商可互换
4. **Kubernetes 原生**：为 K8s 构建，使用 K8s 原语
5. **可扩展性**：从一开始就支持水平扩展

## 架构图

```
┌──────────────────────────────────────────────────────────────────┐
│                          用户浏览器                               │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                   APISIX / Higress                               │
│              (API 网关、认证、限流、路由)                          │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                    Istio 服务网格                                │
│         (流量管理、mTLS 安全、可观测性)                           │
└───┬──────────────────┬──────────────────┬───────────────────────┬──┘
    │                  │                  │                       │
    ▼                  ▼                  ▼                       ▼
┌─────────┐     ┌──────────┐     ┌──────────┐          ┌──────────────┐
│ 前端    │     │ API 网关  │     │  后端    │          │  监控/日志   │
│(Vue 3)  │     │ (可选)    │     │  服务    │          │    服务      │
└─────────┘     └──────────┘     └────┬─────┘          └──────────────┘
                                     │
        ┌─────────────────────────────┼─────────────────────────┐
        │                             │                         │
        ▼                             ▼                         ▼
┌──────────────┐           ┌──────────────┐          ┌──────────────┐
│  Kube 管理器 │           │  AI 巡检     │          │  DevOps      │
│  (K8s 资源)  │           │  服务        │          │  服务        │
└──────────────┘           └──────────────┘          └──────────────┘
        │                             │                         │
        └─────────────────────────────┴─────────────────────────┘
                                      │
                                      ▼
                      ┌─────────────────────────────────┐
                      │      Kubernetes API             │
                      └─────────────────────────────────┘
                                      │
        ┌─────────────────────────────┼─────────────────────────┐
        │                             │                         │
        ▼                             ▼                         ▼
┌──────────────┐           ┌──────────────┐          ┌──────────────┐
│  K8s API     │           │ OpenAI/      │          │ Jenkins/     │
│  Server      │           │ Ollama       │          │ ArgoCD       │
└──────────────┘           └──────────────┘          └──────────────┘
```

**架构层次说明：**

1. **接入层**：APISIX/Higress 作为统一流量入口
2. **服务网格层**：Istio 提供流量管理、安全、可观测性
3. **应用层**：前端 + 后端微服务
4. **数据层**：K8s API、外部服务集成

## 核心组件

### 1. API 网关层 (APISIX / Higress)

**职责：**
- 统一流量入口
- 动态路由和负载均衡
- 认证授权（JWT、Keycloak、OpenID Connect）
- 限流熔断
- 灰度发布和 A/B 测试
- API 版本控制
- WAF 防护（Higress）

**技术选型：**

**APISIX**（推荐）：
- 基于 OpenResty + LuaJIT
- 高性能（单核 QPS > 20000）
- 丰富的插件生态
- 动态配置无重启
- 支持 gRPC、Dubbo、WebSocket

**Higress**：
- 阿里云开源
- 与 Istio 深度集成
- 支持 Gateway API
- 内置 WAF 防护
- 插件市场

**扩展性：**
- 水平扩展无状态
- 配置热更新
- 插件化架构

### 2. Istio 服务网格

**职责：**
- 微服务间流量管理
- mTLS 加密通信
- 细粒度访问控制
- 可观测性（追踪、指标、日志）
- 故障注入和混沌工程

**核心功能：**

**流量管理：**
- 智能路由（基于 Header、Cookie、URL）
- 灰度发布（金丝雀、蓝绿）
- 流量镜像（测试环境）
- 超时重试策略
- 故障注入测试

**安全：**
- 服务间 mTLS 认证
- JWT/OIDC 认证集成
- 细粒度授权策略
- 安全策略执行

**可观测性：**
- 分布式追踪（Jaeger、Zipkin）
- 服务级指标（Prometheus）
- 访问日志收集
- Dashboard（Kiali）

**技术栈：**
- Envoy Sidecar 代理
- Pilot（控制平面）
- Citadel（证书管理）
- Galley（配置验证）

### 3. Kube 管理器

**职责：**
- 所有 K8s 资源的 CRUD 操作
- CRD 发现和动态模式处理
- 通过 WebSocket 实时资源监控
- 资源验证和策略执行
- 多集群支持

**技术栈：**
- Go + controller-runtime
- client-go 用于 K8s API 通信
- Informers 用于高效的资源监控
- 自定义资源定义（CRD）支持

**核心特性：**
- 使用 Informers 高效监控资源
- 缓存层减少 API 服务器负载
- 资源版本控制和冲突检测

### 4. AI 巡检服务

**职责：**
- 资源使用异常检测
- 配置分析和优化建议
- 安全漏洞扫描
- 成本优化建议
- 日志分析（基于 NLP）

**数据来源：**
- Kubernetes API（资源、事件）
- Prometheus 指标
- 日志服务的日志数据
- PostgreSQL 的历史数据

**AI 提供商：**
- OpenAI GPT-4
- 本地 LLM（Ollama）
- 自定义模型

**架构：**
```
┌────────────────────────────────────────────────────────────┐
│                    AI 巡检服务                              │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   指标采集   │  │   日志分析   │  │  资源分析    │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
│         │                 │                  │            │
│         └─────────────────┴──────────────────┘            │
│                           │                                │
│                    ┌──────▼───────┐                        │
│                    │   分析引擎   │                        │
│                    └──────┬───────┘                        │
│                           │                                │
│                    ┌──────▼───────┐                        │
│                    │  AI 提供商   │                        │
│                    │   接口层     │                        │
│                    └──────────────┘                        │
└────────────────────────────────────────────────────────────┘
```

### 5. DevOps 服务

**职责：**
- Jenkins 任务管理
- ArgoCD 应用管理
- 流水线可视化
- 代码质量集成
- 部署自动化

**Jenkins 集成：**
- 任务创建和配置
- 构建触发
- 状态监控
- 日志检索

**ArgoCD 集成：**
- 应用同步
- 部署状态
- 回滚操作
- GitOps 工作流管理

### 6. 日志服务

**架构：**
```
┌──────────────────────────────────────────────────────────┐
│                    日志服务                               │
├──────────────────────────────────────────────────────────┤
│                   ┌──────────────┐                       │
│                   │   日志路由   │                       │
│                   └──────┬───────┘                       │
│          ┌───────────────┼───────────────┐               │
│          ▼               ▼               ▼               │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │
│  │     ELK      │ │     Loki     │ │   自定义     │     │
│  │   提供商     │ │   提供商     │ │   提供商     │     │
│  └──────────────┘ └──────────────┘ └──────────────┘     │
└──────────────────────────────────────────────────────────┘
```

**方案选择：**

**ELK Stack：**
- Vector/Fluentd：日志采集
- Elasticsearch：日志存储和索引
- Kibana：可视化

**Loki Stack：**
- Vector：日志采集
- VictoriaLogs/Loki：日志存储
- Grafana：可视化

### 7. 监控服务

**架构：**
```
┌──────────────────────────────────────────────────────────┐
│                  监控服务                                │
├──────────────────────────────────────────────────────────┤
│                   ┌──────────────┐                       │
│                   │  指标查询    │                       │
│                   │    引擎      │                       │
│                   └──────┬───────┘                       │
│          ┌───────────────┼───────────────┐               │
│          ▼               ▼               ▼               │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │
│  │  Prometheus  │ │VictoriaMetrics│ │   自定义     │     │
│  │   提供商     │ │   提供商      │ │   提供商     │     │
│  └──────────────┘ └──────────────┘ └──────────────┘     │
└──────────────────────────────────────────────────────────┘
```

**方案选择：**

**Prometheus Stack：**
- Prometheus：指标采集和存储
- Grafana：仪表盘可视化
- AlertManager：告警路由

**VictoriaMetrics Stack：**
- Prometheus：指标采集（远程写入）
- VictoriaMetrics（集群）：长期存储
- Grafana：仪表盘可视化

## 数据流

### 资源管理流程

```
用户 → 前端 → API 网关 → Kube 管理器 → Kubernetes API
  ←         ←          ←            ←              ←
```

### AI 巡检流程

```
调度器 → AI 巡检服务 → 数据采集器
                              ↓
                    (指标、日志、资源)
                              ↓
                         分析引擎
                              ↓
                         AI 提供商
                              ↓
                    报告生成器
                              ↓
                    数据库 + 通知
```

### CI/CD 流程

```
开发者 → Git 推送 → Jenkins (构建/测试)
                              ↓
                      Docker 镜像仓库
                              ↓
                      ArgoCD (部署)
                              ↓
                    Kubernetes 集群
                              ↓
                    监控和日志
```

## 通信协议

### 外部 API
- **协议**：HTTP/REST
- **格式**：JSON
- **认证**：JWT
- **文档**：OpenAPI 3.0 (Swagger)

### 内部服务通信
- **协议**：gRPC
- **格式**：Protocol Buffers
- **服务发现**：Kubernetes DNS
- **负载均衡**：Kubernetes Service

### 实时通信
- **协议**：WebSocket
- **用例**：资源更新、日志流、指标

## 部署架构

### 开发环境
```
┌─────────────────────────────────────┐
│         本地机器                     │
│  ┌───────────────────────────────┐  │
│  │  Docker Compose (依赖项)      │  │
│  │  - PostgreSQL                 │  │
│  │  - Redis                      │  │
│  │  - NATS                       │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  后端服务 (Go run)            │  │
│  │  - API 网关                   │  │
│  │  - Kube 管理器                │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │  前端 (npm run dev)           │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### 生产环境
```
┌──────────────────────────────────────────────────────────┐
│                    Kubernetes 集群                       │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │            命名空间: kubeops                     │    │
│  │                                                  │    │
│  │  ┌──────────────┐  ┌──────────────┐             │    │
│  │  │ API 网关     │  │  前端        │             │    │
│  │  │  (3x Pods)   │  │  (2x Pods)   │             │    │
│  │  └──────────────┘  └──────────────┘             │    │
│  │                                                  │    │
│  │  ┌──────────────┐  ┌──────────────┐             │    │
│  │  │Kube 管理器   │  │ AI 巡检      │             │    │
│  │  │  (3x Pods)   │  │  (2x Pods)   │             │    │
│  │  └──────────────┘  └──────────────┘             │    │
│  │                                                  │    │
│  │  ┌──────────────┐  ┌──────────────┐             │    │
│  │  │  PostgreSQL  │  │   Redis      │             │    │
│  │  └──────────────┘  └──────────────┘             │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │            命名空间: logging                     │    │
│  │              ELK 或 Loki Stack                   │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │            命名空间: monitoring                  │    │
│  │       Prometheus 或 VictoriaMetrics             │    │
│  └─────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────┘
```

## 可扩展性考虑

### 水平扩展
- 所有服务无状态
- 会话数据存储在 Redis
- 数据库连接池
- 通过 Kubernetes Service 负载均衡

### 垂直扩展
- 资源请求/限制可配置
- 基于 CPU/内存自动扩缩容
- 数据库连接池

### 性能优化
- 缓存层（Redis）
- 高效的资源监控（Informers）
- 查询优化
- 静态资源 CDN

## 安全架构

### 认证
- 基于JWT的无状态认证
- OAuth2/OIDC 支持（SSO 集成）
- 多因素认证（MFA）

### 授权
- 基于角色的访问控制（RBAC）
- 基于命名空间的隔离
- 资源级权限

### 网络安全
- 服务间通信的网络策略
- TLS/mTLS 加密通信
- Ingress TLS 终止

### 数据安全
- 静态数据加密
- 数据库加密
- 审计日志

## 可扩展性

### 插件系统
所有主要组件都支持插件：

```go
type Plugin interface {
    Name() string
    Initialize(config Config) error
    Execute(ctx context.Context, input interface{}) (interface{}, error)
    Cleanup() error
}
```

### 自定义提供商
- 日志提供商
- 监控提供商
- AI 提供商
- 通知提供商

### CRD 支持
自定义资源定义的动态发现和管理

## 监控和可观测性

### 指标
- Prometheus 指标暴露
- 服务级指标（延迟、吞吐量）
- 业务指标（集群健康度、用户活动）

### 日志
- 结构化 JSON 日志
- 日志级别（DEBUG、INFO、WARN、ERROR）
- 请求追踪

### 追踪
- 分布式追踪（OpenTelemetry）
- 请求关联 ID
- 性能分析

## 灾难恢复

### 高可用性
- 多副本部署
- Pod 反亲和性
- 自动故障转移

### 备份策略
- 数据库备份（PostgreSQL WAL）
- 配置版本控制（Git）
- 灾难恢复程序

### 数据恢复
- 时间点恢复
- 复制延迟监控
- 备份验证
